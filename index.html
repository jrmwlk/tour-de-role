<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tour de rôle — Équipe</title>
  <style>
    body { background:#111; color:#eee; font-family:sans-serif; }
    .person { margin:6px; padding:6px; border:1px solid #444; border-radius:8px; }
    button { margin:2px; padding:4px 8px; }
    .fn-btn { background:#333; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    .fn-btn:hover { background:#555; }
    .abs-btn { background:#800; color:#fff; border:none; padding:4px 8px; border-radius:4px; }
  </style>
</head>
<body>
  <h2>Équipe — Tour de rôle</h2>
  <div id="team">Chargement…</div>

<script>
const SHEET_JSON = "PASTE_SHEET_JSON_URL_HERE";
const WEBAPP_URL = "PASTE_YOUR_WEBAPP_URL_HERE";

async function fetchEquipe(){
  const res = await fetch(WEBAPP_URL+"?action=equipe");
  return await res.json();
}
async function fetchTours(){
  const res = await fetch(WEBAPP_URL+"?action=tours");
  return await res.json();
}
async function assign(nom,fn){
  await fetch(WEBAPP_URL+`?action=assign&nom=${encodeURIComponent(nom)}&fn=${encodeURIComponent(fn)}`);
  render();
}
async function retourAbs(nom){
  await fetch(WEBAPP_URL+`?action=abs&nom=${encodeURIComponent(nom)}`);
  render();
}

async function render(){
  const equipe = await fetchEquipe();
  const tours = await fetchTours();
  const div=document.getElementById('team');
  div.innerHTML='';
  equipe.equipe.forEach(p=>{
    const box=document.createElement('div');
    box.className='person';
    box.innerHTML=`<b>${p.nom}</b> `;
    for(const fn in p.fonctions){
      const val=p.fonctions[fn];
      const btn=document.createElement('button');
      btn.className='fn-btn';
      btn.textContent=fn;
      btn.onclick=()=>assign(p.nom,fn);

      // afficher rang seulement si X et dans tours
      if(val==='X' && tours[fn]){
        let rangObj=tours[fn].find(x=>x.nom===p.nom);
        if(rangObj){
          btn.textContent=`${fn} (#${rangObj.rang})`;
        }
      }
      box.appendChild(btn);
    }
    const abs=document.createElement('button');
    abs.className='abs-btn';
    abs.textContent='RETOUR ABS';
    abs.onclick=()=>retourAbs(p.nom);
    box.appendChild(abs);

    div.appendChild(box);
  });
}

render();
</script>
</body>
</html>