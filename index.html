<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tours de rÃ´le â€“ Interface</title>
  <style>
    :root{
      --bg:#0f1115;
      --card:#161a21;
      --text:#e9eef7;
      --muted:#98a2b3;
      --accent:#4CAF50;       /* semaine */
      --accent-2:#FF7043;     /* dimanche */
      --line:#262b36;
      --btn:#232a36;
      --ok:#00c853;
      --warn:#ff6d00;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:12px 0 8px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
    .pill{padding:6px 10px;border-radius:999px;background:#1e2430;color:var(--muted);font-size:12px;border:1px solid var(--line)}
    input,select{background:#151a22;border:1px solid var(--line);color:var(--text);padding:10px;border-radius:10px;outline:none}
    button{border:0;padding:10px 12px;border-radius:10px;color:white;font-weight:600;cursor:pointer}
    .btn-semaine{background:var(--accent)}
    .btn-dimanche{background:var(--accent-2)}
    .btn-ghost{background:#232a36;color:#eaeef7;border:1px solid var(--line)}
    .btn-danger{background:#e53935}
    .fonction{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:space-between;border-bottom:1px dashed var(--line);padding:10px 0}
    .fonction:last-child{border-bottom:0}
    .fn-left{display:flex;align-items:center;gap:10px;min-width:220px}
    .fn-title{font-weight:700;letter-spacing:.3px}
    .next{font-size:13px;color:var(--muted)}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .list{display:flex;gap:6px;flex-wrap:wrap}
    .tag{background:#1e2430;border:1px solid var(--line);color:#cbd5e1;padding:4px 8px;border-radius:999px;font-size:12px}
    .small{font-size:12px;color:var(--muted)}
    .foot{opacity:.8;font-size:12px;margin-top:8px}
    .link{color:#8ab4ff;text-decoration:none}
    .hr{height:1px;background:var(--line);margin:10px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ§­ Tours de rÃ´le</h1>
    <div class="row">
      <div class="card" style="flex:1">
        <div class="row">
          <div class="pill">Date</div>
          <input id="dateInput" type="date"/>
          <div class="pill">Feuille</div>
          <input id="sheetId" placeholder="SHEET_ID (optionnel)"/>
        </div>
        <div class="foot">Astuce: samedi soir et fÃ©riÃ©s â†’ clique <b>Dimanche</b> pour la fonction concernÃ©e.</div>
      </div>
      <div class="card" style="min-width:260px">
        <div class="row" style="justify-content:space-between">
          <div class="pill">Ã‰quipe</div>
          <button class="btn-ghost" id="reloadTeam">Recharger</button>
        </div>
        <div id="teamList" class="list" style="margin-top:8px"></div>
        <div class="foot">Bouton <b>RETOUR ABS</b> dans la liste Ã©quipe (passe dernierÂ·e dans toutes ses listes).</div>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="pill">Affectations du jour</div>
          <div class="small">1 seule fonction par personne</div>
        </div>
        <div id="fonctions"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="pill">Historique (local)</div>
          <div class="inline">
            <button class="btn-ghost" id="exportJson">Exporter JSON</button>
            <button class="btn-ghost" id="clearHistory">Vider</button>
          </div>
        </div>
        <div id="history"></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="pill">Instructions dâ€™intÃ©gration Sheets</div>
      <div class="small">
        - Remplace <code>saveToSheets()</code> par un <code>fetch()</code> vers ton AppsÂ Script WebApp (POST JSON).<br/>
        - Renseigne <b>SHEET_ID</b> si tu veux charger lâ€™Ã©quipe automatiquement via lâ€™API de feuille publiÃ©e (endpoint gviz).<br/>
        - Par dÃ©faut, lâ€™app sauvegarde en <b>localStorage</b> (dÃ©mo offline).
      </div>
    </div>

    <div class="foot">v0.3 â€“ sÃ©paration semaine/dimanche pour CM, STR, CPO. HC/SPE un seul tour (le clic Dimanche ne change que le type dans lâ€™historique).</div>
  </div>

<script>
/** =========================
 *  CONFIG
 *  ========================= */
const CONFIG = {
  SHEET_ID: "", // optionnel : colle ici l'ID de ta Sheet pour charger l'Ã©quipe automatiquement
  TEAM_SHEET_NAME: "Equipe", // onglet avec la liste des noms
};

// Seed Ã©quipe (fallback si pas de sheet). Remplace par ton chargement depuis Google Sheets.
let TEAM = [
  "SCHITZ GUILLAUME",
  "GUIRAMAND JÃ‰RÃ”ME",
  "MALATRAIT JULIEN",
  "SIMITSIDIS YOHAN",
  "DELATTRE ROMAIN",
  "NOVELLI FLORIAN",
  "LOZANO THOMAS",
  "DELATTRE QUENTIN",
  "GATTO BAPTISTE",
  "DEJAMEAU THÃ‰O",
  "LOZANO PAUL",
  "SERRES MAX"
].sort();

/** =========================
 *  Ã‰TAT (persistÃ© en localStorage)
 *  ========================= */
const LS_KEYS = {
  ROSTERS: "tdr_rosters_v03",   // listes de tours
  HISTORY: "tdr_history_v03",   // historique des affectations
};

// Structure des rosters (listes de tours)
const DEFAULT_ROSTERS = {
  CM:     { semaine: [], dimanche: [] },
  STR:    { semaine: [], dimanche: [] },
  CPO:    { semaine: [], dimanche: [] },
  HC:     { unique: [] },
  SPE:    { unique: [] },
};

// Chargement / sauvegarde LS
function loadLS(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  }catch(e){ console.warn(e); return fallback; }
}
function saveLS(key, val){
  localStorage.setItem(key, JSON.stringify(val));
}

let ROSTERS = loadLS(LS_KEYS.ROSTERS, DEFAULT_ROSTERS);
let HISTORY = loadLS(LS_KEYS.HISTORY, []);

// Util: s'assurer que tous les noms TEAM existent dans les rosters (init Ã  1er lancement)
function ensureTeamInRosters(){
  const ensure = (arr)=>{
    TEAM.forEach(n=>{ if(!arr.includes(n)) arr.push(n); });
    // retire inconnus
    for(let i=arr.length-1;i>=0;i--){
      if(!TEAM.includes(arr[i])) arr.splice(i,1);
    }
  }
  ensure(ROSTERS.CM.semaine);
  ensure(ROSTERS.CM.dimanche);
  ensure(ROSTERS.STR.semaine);
  ensure(ROSTERS.STR.dimanche);
  ensure(ROSTERS.CPO.semaine);
  ensure(ROSTERS.CPO.dimanche);
  ensure(ROSTERS.HC.unique);
  ensure(ROSTERS.SPE.unique);
}
ensureTeamInRosters();

/** =========================
 *  UI: rendu Ã©quipe + bouton RETOUR ABS
 *  ========================= */
function renderTeam(){
  const box = document.getElementById("teamList");
  box.innerHTML = "";
  TEAM.forEach(name=>{
    const tag = document.createElement("div");
    tag.className = "tag";
    tag.innerHTML = `
      <span>${name}</span>
      <button class="btn-ghost" style="margin-left:6px" data-name="${name}">RETOUR ABS</button>
    `;
    box.appendChild(tag);
  });

  // Bind
  box.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      const name = e.target.getAttribute("data-name");
      retourABS(name);
    });
  });
}

/** =========================
 *  LOGIQUE RETOUR ABS
 *  - Passe la personne en dernier de toutes les listes oÃ¹ elle est prÃ©sente/Ã©ligible
 *  ========================= */
function moveToEnd(list, name){
  const idx = list.indexOf(name);
  if(idx>-1){
    list.splice(idx,1);
    list.push(name);
  }
}
function retourABS(name){
  moveToEnd(ROSTERS.CM.semaine, name);
  moveToEnd(ROSTERS.CM.dimanche, name);
  moveToEnd(ROSTERS.STR.semaine, name);
  moveToEnd(ROSTERS.STR.dimanche, name);
  moveToEnd(ROSTERS.CPO.semaine, name);
  moveToEnd(ROSTERS.CPO.dimanche, name);
  moveToEnd(ROSTERS.HC.unique, name);
  moveToEnd(ROSTERS.SPE.unique, name);
  saveLS(LS_KEYS.ROSTERS, ROSTERS);
  renderFonctions();
}

/** =========================
 *  UI: Fonctions (ligne compacte = tour + boutons)
 *  ========================= */
const FONCTIONS = [
  { key:"CM",  label:"CM",  type:"dual" },
  { key:"HC",  label:"HC",  type:"single" },
  { key:"STR", label:"STR", type:"dual", isConduite:true },
  { key:"CPO", label:"CPO", type:"dual", isConduite:true },
  { key:"SPE", label:"SPE", type:"single" },
];

function renderFonctions(){
  ensureTeamInRosters();
  const root = document.getElementById("fonctions");
  root.innerHTML = "";
  FONCTIONS.forEach(fn=>{
    const container = document.createElement("div");
    container.className = "fonction";

    // DÃ©terminer le "prochain" selon liste
    let nextSemaine = null;
    let nextDimanche = null;
    if(fn.type==="dual"){
      nextSemaine  = (ROSTERS[fn.key].semaine[0]) || "â€”";
      nextDimanche = (ROSTERS[fn.key].dimanche[0]) || "â€”";
    }else{
      nextSemaine  = (ROSTERS[fn.key].unique[0]) || "â€”";
      nextDimanche = nextSemaine; // mÃªme liste (on diffÃ©renciera juste dans l'historique)
    }

    // Combo override manuel
    const selectId = `sel_${fn.key}`;
    const selectHtml = `<select id="${selectId}"><option value="">(auto)</option>${TEAM.map(n=>`<option>${n}</option>`).join("")}</select>`;

    container.innerHTML = `
      <div class="fn-left">
        <div class="fn-title">${fn.label}</div>
        <div class="next">Prochain Semaine: <b>${nextSemaine}</b></div>
        <div class="next">Prochain Dimanche: <b>${nextDimanche}</b></div>
      </div>
      <div class="inline">
        ${selectHtml}
        <button class="btn-semaine" data-fn="${fn.key}" data-when="semaine">Semaine</button>
        <button class="btn-dimanche" data-fn="${fn.key}" data-when="dimanche">Dimanche</button>
      </div>
    `;
    root.appendChild(container);
  });

  // Bind affectations
  root.querySelectorAll("button").forEach(btn=>{
    const when = btn.getAttribute("data-when");
    const fnKey = btn.getAttribute("data-fn");
    if(!when || !fnKey) return;
    btn.addEventListener("click", ()=>{
      const sel = document.getElementById(`sel_${fnKey}`);
      const selected = sel && sel.value ? sel.value : null;
      affecter(fnKey, when, selected);
    });
  });
}

/** =========================
 *  AFFECTATION
 *  RÃ¨gles:
 *   - 1 fonction max par personne par date
 *   - STR/CPO: si affectÃ©, descendre en dernier dans les 2 listes du type choisi (semaine OU dimanche)
 *   - CM: descendre en dernier dans la liste du type choisi seulement
 *   - HC/SPE: une seule liste (unique). Le clic Dimanche ne fait que tagger l'historique.
 *  ========================= */
function getDateStr(){
  const input = document.getElementById("dateInput");
  const d = input.value ? new Date(input.value) : new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function assignedTodaySet(dateStr){
  // Personnes dÃ©jÃ  affectÃ©es sur cette date
  const set = new Set();
  for(const h of HISTORY){
    if(h.date===dateStr){ set.add(h.nom); }
  }
  return set;
}

function rotate(list, chosen){
  if(!list.length) return null;
  const name = chosen || list[0];
  const idx = list.indexOf(name);
  if(idx===-1) return null;
  list.splice(idx,1);
  list.push(name);
  return name;
}

function affecter(fnKey, when, chosen){
  const dateStr = getDateStr();
  const used = assignedTodaySet(dateStr);

  // dÃ©terminer liste(s)
  let name = null;
  if(fnKey==="HC" || fnKey==="SPE"){
    // liste unique
    const list = ROSTERS[fnKey].unique;
    const auto = list.find(n=>!used.has(n));
    name = rotate(list, chosen || auto);
    if(!name){ alert("Liste vide ou tout le monde dÃ©jÃ  affectÃ© aujourd'hui."); return; }
    recordHistory({date:dateStr, nom:name, fonction:fnKey, type:when, position:getPosition(list, name)});
  }else if(fnKey==="CM"){
    const list = ROSTERS.CM[when];
    const auto = list.find(n=>!used.has(n));
    name = rotate(list, chosen || auto);
    if(!name){ alert("Liste CM vide ou tout le monde dÃ©jÃ  affectÃ© aujourd'hui."); return; }
    recordHistory({date:dateStr, nom:name, fonction:"CM", type:when, position:getPosition(list, name)});
  }else if(fnKey==="STR" || fnKey==="CPO"){
    const listMain = ROSTERS[fnKey][when];
    const auto = listMain.find(n=>!used.has(n));
    name = rotate(listMain, chosen || auto);
    if(!name){ alert("Liste conduite vide ou tout le monde dÃ©jÃ  affectÃ© aujourd'hui."); return; }

    // rÃ¨gle conduite: descendre aussi dans l'autre liste du mÃªme type
    const otherKey = fnKey==="STR" ? "CPO" : "STR";
    const otherList = ROSTERS[otherKey][when];
    // assurer que la personne existe dans l'autre liste
    if(!otherList.includes(name)) otherList.push(name);
    moveToEnd(otherList, name);

    recordHistory({date:dateStr, nom:name, fonction:fnKey, type:when, position:getPosition(listMain, name)});
  }

  saveLS(LS_KEYS.ROSTERS, ROSTERS);
  renderFonctions();
  renderHistory();
}

// Position (1-index) dans la liste aprÃ¨s rotation (utile pour stats)
function getPosition(list, name){
  const idx = list.indexOf(name);
  return idx===-1 ? null : (idx+1);
}

/** =========================
 *  HISTORIQUE (local) + hook Sheets (Ã  remplacer)
 *  ========================= */
function recordHistory(entry){
  HISTORY.push(entry);
  saveLS(LS_KEYS.HISTORY, HISTORY);
  saveToSheets(entry); // stub Ã  remplacer par fetch vers Apps Script
}

function saveToSheets(entry){
  // TODO: remplace par ton endpoint Apps Script (POST)
  // fetch("https://script.google.com/macros/s/XXX/exec",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(entry)})
  console.log("Save to Sheets (stub):", entry);
}

function renderHistory(){
  const box = document.getElementById("history");
  if(!HISTORY.length){ box.innerHTML = `<div class="small">Aucun enregistrement pour lâ€™instant.</div>`; return; }
  // Derniers d'abord
  const rows = [...HISTORY].reverse().slice(0,150).map(h=>{
    return `<div class="row" style="justify-content:space-between;border-bottom:1px dashed var(--line);padding:6px 0">
      <div>${h.date}</div>
      <div>${h.nom}</div>
      <div class="pill">${h.fonction}</div>
      <div class="pill" style="background:${h.type==='semaine'?'#1f3a26':'#3a211b'}">${h.type}</div>
      <div class="small">pos: ${h.position??'â€”'}</div>
    </div>`
  }).join("");
  box.innerHTML = rows;
}

/** =========================
 *  CHARGEMENT Ã‰QUIPE depuis Google Sheets (optionnel)
 *  - Publie ton onglet "Equipe" au format web
 *  - Utilise l'endpoint gviz pour lire en JSONP
 *  ========================= */
async function loadTeamFromSheet(sheetId){
  try{
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(CONFIG.TEAM_SHEET_NAME)}`;
    const res = await fetch(url);
    const text = await res.text();
    const json = JSON.parse(text.substring(47, text.length - 2)); // gviz jsonp
    const rows = json.table.rows;
    const names = [];
    for(const r of rows){
      const c0 = r.c && r.c[0] ? r.c[0].v : null;
      if(c0 && typeof c0 === "string") names.push(c0.trim());
    }
    if(names.length){
      TEAM = [...new Set(names)].sort();
      // S'assurer que chaque personne existe dans chaque liste
      ensureTeamInRosters();
      renderTeam();
      renderFonctions();
    }else{
      alert("Aucun nom trouvÃ© dans la sheet.");
    }
  }catch(e){
    console.warn(e);
    alert("Ã‰chec du chargement depuis la sheet. VÃ©rifie l'ID et la publication.");
  }
}

/** =========================
 *  EXPORT / CLEAR
 *  ========================= */
document.getElementById("exportJson").addEventListener("click", ()=>{
  const payload = {
    rosters: ROSTERS,
    history: HISTORY
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `tours_role_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
});

document.getElementById("clearHistory").addEventListener("click", ()=>{
  if(confirm("Vider lâ€™historique local ?")){
    HISTORY = [];
    saveLS(LS_KEYS.HISTORY, HISTORY);
    renderHistory();
  }
});

/** =========================
 *  INIT
 *  ========================= */
(function init(){
  // Date par dÃ©faut = aujourdâ€™hui (en local)
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  document.getElementById("dateInput").value = `${yyyy}-${mm}-${dd}`;

  // Binder sheet field & reload
  const sheetField = document.getElementById("sheetId");
  sheetField.value = CONFIG.SHEET_ID;
  sheetField.addEventListener("change", (e)=>{
    CONFIG.SHEET_ID = e.target.value.trim();
  });
  document.getElementById("reloadTeam").addEventListener("click", ()=>{
    if(!CONFIG.SHEET_ID){ alert("Renseigne dâ€™abord un SHEET_ID."); return; }
    loadTeamFromSheet(CONFIG.SHEET_ID);
  });

  renderTeam();
  renderFonctions();
  renderHistory();
})();
</script>
</body>
</html>
