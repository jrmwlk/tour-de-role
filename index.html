<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tour de rôle</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#141821; --muted:#2a2f3a; --line:#1e2430;
      --text:#e6e6e6; --sub:#9aa3b2; --brand:#6bc2ff;
      --sticky-top: 56px; /* sera recalculé en JS */
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    header{
      position:sticky; top:0; z-index:5;
      background:linear-gradient(180deg,var(--bg),rgba(15,17,21,.84));
      backdrop-filter: blur(6px);
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px; border-bottom:1px solid var(--line);
    }
    h1{margin:0; font-size:16px; letter-spacing:.3px}
    .tools{display:flex; gap:8px; align-items:center}
    input[type="date"]{
      background:#12151c; color:var(--text); border:1px solid var(--line);
      padding:6px 8px; border-radius:8px; font-size:14px;
    }
    .btn{
      background:#1a1f29; color:var(--text); border:1px solid var(--line);
      padding:6px 10px; border-radius:10px; font-size:13px; cursor:pointer;
    }
    .btn:hover{background:#212837}
    .btn.primary{border-color:#2a394f}
    .btn.approve{border-color:#214c2b; background:#142418}
    .wrap{padding:12px}
    .table-wrap{
      overflow-x:auto; -webkit-overflow-scrolling:touch;
      border:1px solid var(--line); border-radius:12px; background:var(--panel);
      margin-top:8px; /* évite que la 1ère ligne colle au header sticky */
    }
    table{
      width:100%; border-collapse:separate; border-spacing:0;
      min-width: 720px; /* scroll horizontal sur petits écrans */
    }
    thead th{
      font-weight:600; font-size:12px; color:var(--sub);
      background:#12161f; border-bottom:1px solid var(--line);
      padding:8px 6px; text-align:center; position:sticky; top:var(--sticky-top); z-index:4;
    }
    tbody td{
      border-bottom:1px solid var(--line); text-align:center; padding:4px 4px; font-size:12px;
    }
    tbody tr:first-child td{ /* espace anti-recouvrement sous l'en-tête */
      padding-top: calc(2px + 0px);
    }
    tbody tr:last-child td{border-bottom:none}
    th:first-child, td:first-child{
      position:sticky; left:0; z-index:3; background:linear-gradient(90deg,#12161f 0%, #141821 30%);
      text-align:left; padding-left:10px;
      min-width: 160px; /* largeur fixe pour le nom */
      white-space: nowrap;
    }
    .cell{
      display:flex; align-items:center; justify-content:center; gap:4px;
      flex-direction: column; /* bouton au-dessus, badge en dessous */
    }
    .assign{
      min-width:52px; padding:5px 6px; border-radius:8px; border:1px solid var(--muted);
      background:#171c25; cursor:pointer; user-select:none; font-size:11px; line-height:1.1;
    }
    .assign[disabled]{opacity:.28; cursor:not-allowed}
    .assign.active{ border-color:#2d7bd8; box-shadow:0 0 0 2px rgba(45,123,216,.25) inset}
    .assign.novice{ border-style:dashed; border-color:#755a2a; background:#1a1710 }
    .assign.novice.active{ box-shadow:0 0 0 2px rgba(242,167,75,.25) inset; border-color:#f2a74b }
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:24px; padding:1px 6px; border-radius:999px; font-size:10px;
      border:1px solid var(--muted); color:var(--sub);
    }
    .abs{ background:#2a1a1a; border-color:#5a2d2d; color:#ffb3b3 }
    .footbar{ display:flex; gap:8px; justify-content:center; margin:12px 0 2px }
    .hidden{ display:none !important }
    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center;
    }
    .modal{ background:#10151e; border:1px solid var(--line); border-radius:12px; width:min(560px,92vw); padding:16px }
    .modal h2{ margin:0 0 8px 0; font-size:16px }
    .row{ display:flex; align-items:center; gap:8px; margin:8px 0 }
    .row input[type="text"]{ flex:1; padding:10px; background:#0f131b; color:var(--text); border:1px solid var(--line); border-radius:10px }
    .hint{ font-size:12px; color:var(--sub) }
    .pill{ font-size:11px; border:1px solid var(--line); padding:2px 6px; border-radius:999px; color:var(--sub) }
    .sticky-note{font-size:12px; color:var(--sub); margin:8px 0}
    @media (max-width: 430px){
      h1{ font-size:15px }
      input[type="date"]{ font-size:13px; padding:5px 6px }
      .btn{ font-size:12px; padding:6px 8px }
      th:first-child, td:first-child{ min-width: 140px }
      thead th{ font-size:11px; padding:6px 4px }
      tbody td{ font-size:11px; padding:4px 3px }
      .assign{ min-width:46px; padding:4px 5px; border-radius:7px; font-size:10.5px }
      .badge{ min-width:22px; font-size:9.5px; padding:1px 5px }
    }
  </style>
</head>
<body>
  <header id="appHeader">
    <h1>Tour de rôle</h1>
    <div class="tools">
      <input type="date" id="datePicker"/>
      <button class="btn" id="reloadBtn" title="Recharger">↻</button>
      <button class="btn" id="settingsBtn" title="Paramètres">⚙️</button>
    </div>
  </header>

  <div class="wrap">
    <div id="notice" class="sticky-note"></div>

    <div class="table-wrap">
      <table id="roleTable" class="hidden">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="footbar">
      <button class="btn approve" id="validateBtn">Valider</button>
    </div>
  </div>

  <!-- Modal paramètres -->
  <div class="modal-backdrop hidden" id="modal">
    <div class="modal">
      <h2>Paramètres</h2>
      <div class="row">
        <label for="apiUrl" class="pill">API GAS</label>
        <input type="text" id="apiUrl" placeholder="https://script.google.com/macros/s/XXXXX/exec">
      </div>
      <div class="hint">
        Colle l’URL WebApp Google Apps Script. Les colonnes sont lues depuis la feuille <b>Équipe</b> (tout sauf <b>ID</b> et <b>NOM</b>).<br>
        <b>Règle :</b> <code>X</code> ou <code>N</code> permet l’affectation (avec <code>N</code>, l’agent est toujours dernier côté calcul).
      </div>
      <div class="footbar" style="justify-content:flex-end">
        <button class="btn" id="closeModal">Annuler</button>
        <button class="btn primary" id="saveSettings">Enregistrer</button>
      </div>
    </div>
  </div>

  <script>
    const DEFAULT_FUNCTIONS = ["CM","LIV","HC","DK","DKT","STR","VL","CPO","CPV","SPE","FOR","DEL","CEQ"];
    const state = {
      apiUrl: localStorage.getItem('API_URL') || "",
      date: null,
      functions: [],
      team: [],
      assignments: {},
      retourAbs: new Set()
    };

    const $ = (sel) => document.querySelector(sel);
    function isoDate(d){ return d.toISOString().slice(0,10); }
    function todayLocal(){ const n=new Date(); return new Date(n.getTime()-n.getTimezoneOffset()*60000); }
    function setNotice(msg){ $('#notice').innerHTML = msg || ""; }

    // --- Sticky header dynamique (corrige la 1ère ligne masquée) ---
    function setStickyTop(){
      const hh = document.getElementById('appHeader').offsetHeight || 56;
      document.documentElement.style.setProperty('--sticky-top', (hh) + 'px');
    }
    window.addEventListener('resize', setStickyTop);

    function init(){
      setStickyTop();
      $('#datePicker').value = isoDate(todayLocal());
      state.date = $('#datePicker').value;
      $('#settingsBtn').addEventListener('click', () => $('#modal').classList.remove('hidden'));
      $('#closeModal').addEventListener('click', () => $('#modal').classList.add('hidden'));
      $('#saveSettings').addEventListener('click', () => {
        state.apiUrl = $('#apiUrl').value.trim(); localStorage.setItem('API_URL', state.apiUrl);
        $('#modal').classList.add('hidden'); reload();
      });
      $('#reloadBtn').addEventListener('click', reload);
      $('#validateBtn').addEventListener('click', validate);
      $('#apiUrl').value = state.apiUrl;
      $('#datePicker').addEventListener('change', () => { state.date = $('#datePicker').value; reload(); });
      reload();
    }

    async function reload(){
      setNotice('Chargement…');
      try{
        const data = await fetchData(state.apiUrl, state.date);
        applyData(data);
        renderTable();
        setNotice(state.apiUrl ? 'Données chargées depuis l’API GAS.' : 'Mode démo (renseigne ⚙️ pour activer l’API).');
      }catch(e){
        console.error(e);
        setNotice('<b>Erreur</b> de chargement.');
      }
    }

    async function fetchData(apiUrl, date){
      if(apiUrl){
        const url = apiUrl + (apiUrl.includes('?') ? '&' : '?') + 'date=' + encodeURIComponent(date);
        const res = await fetch(url, {headers:{'Accept':'application/json'}});
        if(!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      }else{
        return mockData(date);
      }
    }

    function mockData(date){
      const team = [
        {id:"77836", nom:"SCHITZ GUILLAUME"},
        {id:"77985", nom:"GUIRAMAND JEROME"},
        {id:"78028", nom:"MALATRAIT JULIEN"},
        {id:"78090", nom:"SIMITSIDIS YOHAN"}
      ];
      const skills = {
        "77836": {CM:'X', LIV:'X', HC:'X', STR:'', VL:'', CPO:'', SPE:'', FOR:'X', DEL:'X', CEQ:'X', DK:'', DKT:'', CPV:''},
        "77985": {CM:'', LIV:'', HC:'X', STR:'X', VL:'', CPO:'X', SPE:'', FOR:'', DEL:'', CEQ:'', DK:'', DKT:'', CPV:''},
        "78028": {CM:'', LIV:'', HC:'X', STR:'X', VL:'', CPO:'N', SPE:'X', FOR:'', DEL:'', CEQ:'', DK:'', DKT:'', CPV:''},
        "78090": {CM:'', LIV:'', HC:'X', STR:'N', VL:'', CPO:'', SPE:'', FOR:'', DEL:'', CEQ:'', DK:'', DKT:'', CPV:''},
      };
      const tours = {}; for(const id in skills){ tours[id] = {}; DEFAULT_FUNCTIONS.forEach(f => tours[id][f] = Math.floor(Math.random()*12)+1); }
      return {date, functions: DEFAULT_FUNCTIONS, team: team.map(p => ({ id:p.id, nom:p.nom, skills: skills[p.id] || {}, tours: tours[p.id] || {} })), assignments: {} };
    }

    function applyData(data){
      state.functions = Array.from(data.functions || []).filter(f => !/^ID$|^NOM$/i.test(f));
      if(state.functions.length === 0) state.functions = DEFAULT_FUNCTIONS;
      state.team = data.team || [];
      state.assignments = data.assignments || {};
      state.retourAbs = new Set();
    }

    function renderTable(){
      const thead = $('#thead'), tbody = $('#tbody');
      $('#roleTable').classList.remove('hidden');
      thead.innerHTML = ""; tbody.innerHTML = "";

      const trh = document.createElement('tr');
      const thName = document.createElement('th'); thName.textContent = "Nom"; trh.appendChild(thName);
      state.functions.forEach(fn => { const th=document.createElement('th'); th.textContent=fn; trh.appendChild(th); });
      const thAbs = document.createElement('th'); thAbs.textContent = "Retour ABS"; trh.appendChild(thAbs);
      thead.appendChild(trh);

      for(const person of state.team){
        const tr = document.createElement('tr');
        const tdName = document.createElement('td'); tdName.textContent = person.nom || ""; tr.appendChild(tdName);

        state.functions.forEach(fn => {
          const td = document.createElement('td');
          const cell = document.createElement('div'); cell.className = 'cell';

          const raw = person.skills ? person.skills[fn] : '';
          const val = (typeof raw === 'string') ? raw.trim().toUpperCase() : (raw === true ? 'X' : '');
          const canDo = (val === 'X' || val === 'N');
          const isNovice = (val === 'N');

          const btn = document.createElement('button');
          btn.className = 'assign' + (isNovice ? ' novice' : '');
          btn.textContent = fn;
          btn.disabled = !canDo;
          if(isNovice){ btn.title = "Peut occuper la fonction mais sera toujours dernier au tour"; }

          const badge = document.createElement('span');
          badge.className = 'badge';
          const tour = person.tours && (person.tours[fn] ?? "");
          badge.textContent = tour !== "" && tour !== undefined ? "#" + tour : "-";

          if(state.assignments[person.id] === fn){ btn.classList.add('active'); }

          btn.addEventListener('click', () => {
            if(btn.disabled) return;
            if(state.assignments[person.id] === fn){
              delete state.assignments[person.id];
              btn.classList.remove('active');
            }else{
              tr.querySelectorAll('.assign.active').forEach(b => b.classList.remove('active'));
              state.assignments[person.id] = fn;
              btn.classList.add('active');
              state.retourAbs.delete(person.id);
              const absBtn = tr.querySelector('.assign.abs'); if(absBtn) absBtn.classList.remove('active');
            }
          });

          cell.appendChild(btn);
          cell.appendChild(badge);
          td.appendChild(cell);
          tr.appendChild(td);
        });

        const tdAbs = document.createElement('td');
        const cellAbs = document.createElement('div'); cellAbs.className = 'cell';
        const btnAbs = document.createElement('button'); btnAbs.className = 'assign abs'; btnAbs.textContent = 'RETOUR ABS';
        btnAbs.addEventListener('click', () => {
          delete state.assignments[person.id];
          state.retourAbs.add(person.id);
          tr.querySelectorAll('.assign').forEach(b => b.classList.remove('active'));
          btnAbs.classList.add('active');
        });
        cellAbs.appendChild(btnAbs);
        tdAbs.appendChild(cellAbs);
        tr.appendChild(tdAbs);

        tbody.appendChild(tr);
      }
    }

    async function validate(){
      const payload = { date: state.date, assignments: state.assignments, retourAbs: Array.from(state.retourAbs) };
      if(!state.apiUrl){ alert('Mode démo : colle ton URL GAS (⚙️) pour envoyer.'); return; }
      try{
        const res = await fetch(state.apiUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json(); alert(data?.message || 'Enregistré !');
      }catch(e){ console.error(e); alert('Erreur lors de l’enregistrement.'); }
    }

    init();
  </script>
</body>
</html>
