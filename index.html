<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tour de rôle</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#141821; --muted:#2a2f3a; --line:#1e2430;
      --text:#e6e6e6; --sub:#9aa3b2; --blue:#4da6ff;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    header{ position:sticky; top:0; z-index:5; background:linear-gradient(180deg,var(--bg),rgba(15,17,21,.84));
      backdrop-filter: blur(6px); display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px; border-bottom:1px solid var(--line); }
    h1{margin:0; font-size:16px; letter-spacing:.3px}
    .tools{display:flex; gap:8px; align-items:center}
    input[type="date"]{ background:#12151c; color:var(--text); border:1px solid var(--line); padding:6px 8px; border-radius:8px; font-size:14px; }
    .btn{ background:#1a1f29; color:var(--text); border:1px solid var(--line); padding:6px 10px; border-radius:10px; font-size:13px; cursor:pointer; }
    .btn:hover{background:#212837} .btn.approve{border-color:#214c2b; background:#142418}
    .wrap{padding:12px}
    .table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; border:1px solid var(--line); border-radius:12px; background:var(--panel); margin-top:8px; position: relative; }
    table{ width:100%; border-collapse:separate; border-spacing:0; min-width: 720px; }
    thead th{ font-weight:600; font-size:12px; color:var(--sub); background:#12161f; border-bottom:1px solid var(--line);
      padding:8px 6px; text-align:center; position: sticky; top: 0; z-index: 4; box-shadow: 0 2px 0 0 var(--line); }
    tbody td{ border-bottom:1px solid var(--line); text-align:center; padding:4px 4px; font-size:12px; }
    tbody tr:last-child td{border-bottom:none}
    th:first-child, td:first-child{ position:sticky; left:0; z-index:3; background:linear-gradient(90deg,#12161f 0%, #141821 30%);
      text-align:left; padding-left:10px; min-width: 160px; white-space: nowrap; }
    thead th:first-child{ z-index:5 }
    td.highlight{ color: var(--blue); font-weight: 600; }
    .cell{ display:flex; align-items:center; justify-content:center; gap:4px; flex-direction: column; }
    .assign{ min-width:52px; padding:5px 6px; border-radius:8px; border:1px solid var(--muted); background:#171c25; cursor:pointer; user-select:none; font-size:11px; line-height:1.1; }
    .assign[disabled]{opacity:.28; cursor:not-allowed}
    .assign.active{ border-color:#2d7bd8; box-shadow:0 0 0 2px rgba(45,123,216,.25) inset}
    .assign.driving{ border-color:#355a8a; background:#131a25 }   /* C = conduite */
    .assign.fixed{ border-color:#2b4d2e; background:#151e16 }     /* nombre = tour fixe */
    .assign.info{ border-color:#3a3f4a; background:#1a1f28 }      /* fonctions info-only (pas de tour) */
    .badge{ display:inline-flex; align-items:center; justify-content:center; min-width:24px; padding:1px 6px; border-radius:999px; font-size:10px;
      border:1px solid var(--muted); color:var(--sub); }
    .badge.dim{ opacity:.6 }
    .abs{ background:#2a1a1a; border-color:#5a2d2d; color:#ffb3b3 }
    .footbar{ display:flex; gap:8px; justify-content:center; margin:12px 0 2px }
    .hidden{ display:none !important }
    @media (max-width: 430px){
      h1{ font-size:15px } input[type="date"]{ font-size:13px; padding:5px 6px } .btn{ font-size:12px; padding:6px 8px }
      th:first-child, td:first-child{ min-width: 140px } thead th{ font-size:11px; padding:6px 4px } tbody td{ font-size:11px; padding:4px 3px }
      .assign{ min-width:46px; padding:4px 5px; border-radius:7px; font-size:10.5px } .badge{ min-width:22px; font-size:9.5px; padding:1px 5px }
    }
  </style>
</head>
<body>
  <header>
    <h1>Tour de rôle</h1>
    <div class="tools">
      <input type="date" id="datePicker"/>
      <button class="btn" id="reloadBtn" title="Recharger">↻</button>
      <button class="btn" id="settingsBtn" title="Paramètres">⚙️</button>
    </div>
  </header>

  <div class="wrap">
    <div id="notice" class="sticky-note"></div>

    <div class="table-wrap">
      <table id="roleTable" class="hidden">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="footbar">
      <button class="btn approve" id="validateBtn">Valider</button>
    </div>
  </div>

  <script>
    // Fonctions sans tour (informative uniquement)
    const INFO_ONLY = new Set(["VL","CEQ","FOR","DEL"]);
    const DEFAULT_FUNCTIONS = ["CM","LIV","HC","DK","DKT","STR","VL","CPO","CPV","SPE","FOR","DEL","CEQ"];
    const state = {
      apiUrl: localStorage.getItem('API_URL') || "",
      date: new Date().toISOString().slice(0,10),
      functions: [],
      team: [],
      assignments: {},
      retourAbs: new Set()
    };

    const $ = (sel) => document.querySelector(sel);
    function setNotice(msg){ $('#notice').innerHTML = msg || ""; }

    function init(){
      $('#datePicker').value = state.date;
      $('#reloadBtn').addEventListener('click', reload);
      $('#validateBtn').addEventListener('click', validate);
      reload();
    }

    async function reload(){
      setNotice('Chargement…');
      try{
        const data = mockData(state.date); // Remplacer par fetch API GAS plus tard
        applyData(data);
        renderTable();
        setNotice('Mode démo. Brancher API GAS pour données réelles.');
      }catch(e){
        console.error(e);
        setNotice('<b>Erreur</b> de chargement.');
      }
    }

    // --- DEMO DATA (à remplacer par API GAS) ---
    function mockData(date){
      const team = [
        {id:"77836", nom:"SCHITZ GUILLAUME"},
        {id:"77985", nom:"GUIRAMAND JEROME"},
        {id:"78028", nom:"MALATRAIT JULIEN"},
        {id:"78090", nom:"SIMITSIDIS YOHAN"}
      ];
      // Valeurs possibles: 'X', 'C', '1'..'15', ''.
      const skills = {
        "77836": {CM:'X', LIV:'X', HC:'X', STR:'',  VL:'X',  CPO:'',  SPE:'', FOR:'X', DEL:'X', CEQ:'X', DK:'', DKT:'', CPV:''},
        "77985": {CM:'',  LIV:'',  HC:'X', STR:'C',  VL:'',  CPO:'X',  SPE:'', FOR:'',  DEL:'',  CEQ:'',  DK:'X', DKT:'X', CPV:''},
        "78028": {CM:'',  LIV:'',  HC:'X', STR:'X',  VL:'',  CPO:'12', SPE:'X', FOR:'',  DEL:'',  CEQ:'',  DK:'X', DKT:'',  CPV:''},
        "78090": {CM:'',  LIV:'',  HC:'X', STR:'',  VL:'',  CPO:'',  SPE:'', FOR:'',  DEL:'',  CEQ:'',  DK:'X', DKT:'X', CPV:''},
      };
      const tours = {}; for(const id in skills){ tours[id] = {}; DEFAULT_FUNCTIONS.forEach(f => tours[id][f] = Math.floor(Math.random()*12)+1); }
      return {date, functions: DEFAULT_FUNCTIONS, team: team.map(p => ({ id:p.id, nom:p.nom, skills: skills[p.id] || {}, tours: tours[p.id] || {} })), assignments: {} };
    }

    function applyData(data){
      state.functions = Array.from(data.functions || []).filter(f => !/^ID$|^NOM$/i.test(f));
      if(state.functions.length === 0) state.functions = DEFAULT_FUNCTIONS;
      state.team = data.team || [];
      state.assignments = data.assignments || {};
      state.retourAbs = new Set();
    }

    function parseSkill(valRaw){
      // Retourne {canDo, type: 'normal'|'driving'|'fixed'|null, fixedRank:null|number}
      if(valRaw === null || valRaw === undefined) return {canDo:false, type:null, fixedRank:null};
      const s = String(valRaw).trim().toUpperCase();
      if(s === 'X') return {canDo:true, type:'normal', fixedRank:null};
      if(s === 'C') return {canDo:true, type:'driving', fixedRank:null};
      const n = Number(s);
      if(Number.isFinite(n) && n >= 1 && n <= 15) return {canDo:true, type:'fixed', fixedRank:n};
      return {canDo:false, type:null, fixedRank:null};
    }

    function renderTable(){
      const thead = $('#thead'), tbody = $('#tbody');
      $('#roleTable').classList.remove('hidden');
      thead.innerHTML = ""; tbody.innerHTML = "";

      const trh = document.createElement('tr');
      const thName = document.createElement('th'); thName.textContent = "Nom"; trh.appendChild(thName);
      state.functions.forEach(fn => { const th=document.createElement('th'); th.textContent=fn; trh.appendChild(th); });
      const thAbs = document.createElement('th'); thAbs.textContent = "Retour ABS"; trh.appendChild(thAbs);
      thead.appendChild(trh);

      for(const person of state.team){
        const tr = document.createElement('tr');
        const tdName = document.createElement('td'); tdName.textContent = person.nom || ""; tr.appendChild(tdName);

        state.functions.forEach(fn => {
          const td = document.createElement('td');
          const cell = document.createElement('div'); cell.className = 'cell';

          const raw = person.skills ? person.skills[fn] : '';
          const info = parseSkill(raw);
          const isInfoOnly = INFO_ONLY.has(fn);
          const tour = person.tours && (person.tours[fn] ?? "");

          const btn = document.createElement('button');
          btn.className = 'assign';
          if(info.type === 'driving') btn.classList.add('driving');
          if(info.type === 'fixed')   btn.classList.add('fixed');
          if(isInfoOnly)              btn.classList.add('info');
          btn.textContent = fn;
          btn.disabled = !info.canDo;

          const badge = document.createElement('span');
          badge.className = 'badge' + (isInfoOnly ? ' dim' : '');
          badge.textContent = isInfoOnly ? '—' :
                              (info.type === 'fixed' && info.fixedRank ? ("#" + info.fixedRank) :
                               (tour !== "" && tour !== undefined ? "#" + tour : "-"));

          if(state.assignments[person.id] === fn){ btn.classList.add('active'); tdName.classList.add('highlight'); }

          btn.addEventListener('click', () => {
            if(btn.disabled) return;
            if(state.assignments[person.id] === fn){
              delete state.assignments[person.id];
              btn.classList.remove('active');
            }else{
              tr.querySelectorAll('.assign.active').forEach(b => b.classList.remove('active'));
              state.assignments[person.id] = fn;
              btn.classList.add('active');
              state.retourAbs.delete(person.id);
              const absBtn = tr.querySelector('.assign.abs'); if(absBtn) absBtn.classList.remove('active');
            }
            if(state.assignments[person.id]) tdName.classList.add('highlight');
            else tdName.classList.remove('highlight');
          });

          cell.appendChild(btn);
          cell.appendChild(badge);
          td.appendChild(cell);
          tr.appendChild(td);
        });

        // Retour ABS
        const tdAbs = document.createElement('td');
        const cellAbs = document.createElement('div'); cellAbs.className = 'cell';
        const btnAbs = document.createElement('button'); btnAbs.className = 'assign abs'; btnAbs.textContent = 'RETOUR ABS';
        btnAbs.addEventListener('click', () => {
          delete state.assignments[person.id];
          state.retourAbs.add(person.id);
          tr.querySelectorAll('.assign').forEach(b => b.classList.remove('active'));
          btnAbs.classList.add('active');
          tdName.classList.remove('highlight');
        });
        cellAbs.appendChild(btnAbs);
        tdAbs.appendChild(cellAbs);
        tr.appendChild(tdAbs);

        tbody.appendChild(tr);
      }
    }

    async function validate(){
      // Rappel: la règle "DKT deviennent 1er DK (sauf tours fixes)" sera traitée côté backend.
      const payload = { date: state.date, assignments: state.assignments, retourAbs: Array.from(state.retourAbs) };
      console.log(payload);
      alert("Validation (démo): " + JSON.stringify(payload));
    }

    init();
  </script>
</body>
</html>
