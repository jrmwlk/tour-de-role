<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Tour de rôle</title>
  <link rel="apple-touch-icon" href="logo.png">
  <link rel="icon" href="logo.png" type="image/png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root{ --bg:#0f1115; --panel:#141821; --muted:#2a2f3a; --line:#1e2430;
           --text:#e6e6e6; --sub:#9aa3b2; --red:#d82d2d; --red-bg:#3a1212; --red-soft:#ffb3b3; }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    header{ position:sticky; top:0; z-index:5; background:linear-gradient(180deg,var(--bg),rgba(15,17,21,.84));
      backdrop-filter: blur(6px); display:flex; align-items:center; justify-content:space-between;
      padding:8px 12px; border-bottom:1px solid var(--line); gap:8px; }
    .brand{ flex:1 1 auto; text-align:center; }
    .logo-box{ background:#fff; border-radius:12px; display:inline-block; padding:6px; }
    .logo{ display:inline-block; height:52px; max-width:70vw; object-fit:contain }
    h1{ margin:6px 0 0 0; font-size:16px; letter-spacing:.3px }
    .tools{ flex:0 0 auto; display:flex; gap:8px; align-items:center }
    input[type="date"]{ background:#12151c; color:var(--text); border:1px solid var(--line); padding:6px 8px; border-radius:8px; font-size:14px; }
    .btn{ background:#1a1f29; color:var(--text); border:1px solid var(--line); padding:6px 10px; border-radius:10px; font-size:13px; cursor:pointer; }
    .btn:hover{background:#212837} .btn.approve{border-color:#214c2b; background:#142418}
    .wrap{padding:12px}
    .table-wrap{ overflow-x:auto; border:1px solid var(--line); border-radius:12px; background:var(--panel); margin-top:8px; }
    table{ width:100%; border-collapse:separate; border-spacing:0; min-width:720px; }
    thead th{ font-weight:600; font-size:12px; color:var(--sub); background:#12161f; border-bottom:1px solid var(--line);
      padding:8px 6px; text-align:center; position:sticky; top:0; z-index:4; }
    tbody td{ border-bottom:1px solid var(--line); text-align:center; padding:4px 4px; font-size:12px; }
    th:first-child, td:first-child{ position:sticky; left:0; z-index:3; background:#12161f;
      text-align:left; padding-left:10px; min-width:160px; white-space:nowrap; }
    td.highlight{ color:var(--red); font-weight:700; }
    .cell{ display:flex; align-items:center; justify-content:center; gap:4px; flex-direction:column; }
    .assign{ min-width:52px; padding:5px 6px; border-radius:8px; border:1px solid var(--muted); background:#171c25; cursor:pointer; font-size:11px; }
    .assign:disabled{ opacity:.3; cursor:not-allowed }
    .assign.active{ border-color:var(--red); background:var(--red-bg); color:var(--red-soft); }
    .badge{ display:inline-flex; align-items:center; justify-content:center; min-width:24px; padding:1px 6px; border-radius:999px; font-size:10px;
      border:1px solid var(--muted); color:var(--sub); }
    .footbar{ display:flex; gap:8px; justify-content:center; margin:12px 0 2px }
    .hidden{ display:none!important }
    @media (max-width:430px){ .logo{ height:44px } h1{ font-size:15px } .assign{ min-width:46px; padding:4px 5px; font-size:10.5px } }
  </style>
</head>
<body>
  <header>
    <div class="tools">
      <input type="date" id="datePicker"/>
      <button class="btn" id="reloadBtn" title="Recharger">↻</button>
    </div>
    <div class="brand">
      <div class="logo-box"><img src="logo.png" alt="Logo" class="logo"></div>
      <h1>Tour de rôle</h1>
    </div>
    <div class="tools" style="opacity:0; pointer-events:none">
      <input type="date" style="visibility:hidden; width:0">
      <button class="btn" style="visibility:hidden">↻</button>
    </div>
  </header>

  <div class="wrap">
    <div id="notice"></div>
    <div class="table-wrap">
      <table id="roleTable" class="hidden">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="footbar">
      <button class="btn approve" id="validateBtn">Valider</button>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyylZcJzhDxkGpx-XuVjBkobtdD3Ofs4tOTlY2yK93tF-CatVs2v2SaM25En_z86cSK6Q/exec";
    const INFO_ONLY = new Set(["VL","CEQ","FOR","DEL"]);
    const state = { date:new Date().toISOString().slice(0,10), functions:[], team:[], assignments:{} };
    const $ = s => document.querySelector(s);

    function init(){
      $('#datePicker').value = state.date;
      $('#reloadBtn').onclick = reload;
      $('#validateBtn').onclick = validate;
      $('#datePicker').onchange = ()=>{ state.date=$('#datePicker').value; reload(); };
      reload();
    }

    async function reload(){
      try{
        const res = await fetch(API_URL+"?date="+encodeURIComponent(state.date), {headers:{'Accept':'application/json'}});
        if(!res.ok) throw new Error("HTTP "+res.status);
        const data = await res.json();
        state.functions = (data.functions||[]).filter(h=>!/^ID$|^NOM$/i.test(h));
        state.team = data.team||[];
        renderTable();
      }catch(e){ console.error(e); alert("Erreur chargement API"); }
    }

    function canDo(val){
      const s = String(val||"").trim().toUpperCase();
      if(s==='X' || s==='C') return true;
      const n = Number(s); return Number.isFinite(n) && n>=1 && n<=15;
    }

    function renderTable(){
      $('#roleTable').classList.remove('hidden');
      $('#thead').innerHTML=""; $('#tbody').innerHTML="";

      const trh=document.createElement("tr");
      trh.innerHTML="<th>Nom</th>"+state.functions.map(f=>"<th>"+f+"</th>").join("");
      $('#thead').appendChild(trh);

      for(const p of state.team){
        const tr=document.createElement("tr");
        const tdName=document.createElement("td"); tdName.textContent=p.nom||""; tr.appendChild(tdName);

        state.functions.forEach(fn=>{
          const td=document.createElement("td");
          const cell=document.createElement("div"); cell.className="cell";

          const skill = p.skills ? p.skills[fn] : "";
          const enabled = canDo(skill);
          const tour = (p.tours && (p.tours[fn]!==undefined && p.tours[fn]!==null) ? String(p.tours[fn]) : "");
          const isInfo = INFO_ONLY.has(fn);

          const btn=document.createElement("button");
          btn.className="assign"; btn.textContent=fn; btn.disabled=!enabled;
          btn.onclick=()=>{
            if(btn.disabled) return;
            tr.querySelectorAll(".assign").forEach(b=>b.classList.remove("active"));
            if(state.assignments[p.id]===fn){ delete state.assignments[p.id]; tdName.classList.remove("highlight"); }
            else{ state.assignments[p.id]=fn; btn.classList.add("active"); tdName.classList.add("highlight"); }
          };

          const badge=document.createElement("span");
          badge.className="badge";
          if(!enabled || isInfo) badge.textContent = "—";
          else if(/^(\\d+)$/.test(String(skill))) badge.textContent = "#"+skill;
          else badge.textContent = tour ? "#"+tour : "—";

          cell.appendChild(btn); cell.appendChild(badge);
          td.appendChild(cell); tr.appendChild(td);
        });

        $('#tbody').appendChild(tr);
      }
    }

    async function validate(){
      const allIds = state.team.map(p=>p.id);
      const retourAbs = allIds.filter(id=>!state.assignments[id]);
      const payload = { date:state.date, assignments:state.assignments, retourAbs };
      try{
        const res = await fetch(API_URL, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
        const text = await res.text();
        try{
          const json = JSON.parse(text);
          if(json.error) throw new Error(json.error);
          alert(json.message || "OK");
          await reload();
        }catch(parseErr){
          throw new Error(text);
        }
      }catch(e){ console.error(e); alert("Erreur de l’enregistrement :\n"+e.message); }
    }
    init();
  </script>
</body>
</html>
