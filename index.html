<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tour de rôle</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#141821; --muted:#2a2f3a; --line:#1e2430;
      --text:#e6e6e6; --sub:#9aa3b2; --brand:#6bc2ff; --ok:#3fb950; --warn:#f2a74b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    header{
      position:sticky; top:0; z-index:5;
      background:linear-gradient(180deg,var(--bg),rgba(15,17,21,.8));
      backdrop-filter: blur(6px);
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px; border-bottom:1px solid var(--line);
    }
    h1{margin:0; font-size:18px; letter-spacing:.3px}
    .tools{display:flex; gap:8px; align-items:center}
    input[type="date"]{
      background:#12151c; color:var(--text); border:1px solid var(--line);
      padding:6px 10px; border-radius:8px; font-size:14px;
    }
    .btn{
      background:#1a1f29; color:var(--text); border:1px solid var(--line);
      padding:8px 12px; border-radius:10px; font-size:14px; cursor:pointer;
    }
    .btn:hover{background:#212837}
    .btn.primary{border-color:#2a394f}
    .btn.approve{border-color:#214c2b; background:#142418}
    .wrap{padding:16px; max-width:1400px; margin:0 auto}
    table{
      width:100%; border-collapse:separate; border-spacing:0; margin-top:10px;
      background:var(--panel); border:1px solid var(--line); border-radius:12px; overflow:hidden;
    }
    thead th{
      font-weight:600; font-size:13px; color:var(--sub);
      background:#12161f; border-bottom:1px solid var(--line);
      padding:10px 8px; text-align:center; position:sticky; top:54px; z-index:4;
    }
    tbody td{
      border-bottom:1px solid var(--line); text-align:center; padding:6px 6px; font-size:13px;
    }
    tbody tr:last-child td{border-bottom:none}
    th:first-child, td:first-child{ text-align:left; padding-left:12px }
    .cell{
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .assign{
      min-width:58px; padding:6px 8px; border-radius:9px; border:1px solid var(--muted);
      background:#171c25; cursor:pointer; user-select:none; font-size:12px;
    }
    .assign[disabled]{opacity:.25; cursor:not-allowed}
    .assign.active{ border-color:#2d7bd8; box-shadow:0 0 0 2px rgba(45,123,216,.25) inset}
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:28px; padding:2px 6px; border-radius:999px; font-size:11px;
      border:1px solid var(--muted); color:var(--sub);
    }
    .abs{
      background:#2a1a1a; border-color:#5a2d2d; color:#ffb3b3;
    }
    .muted{ color:var(--sub) }
    .footbar{ display:flex; gap:8px; justify-content:center; margin:16px 0 4px }
    .hidden{ display:none !important }
    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center;
    }
    .modal{ background:#10151e; border:1px solid var(--line); border-radius:12px; width:min(560px,92vw); padding:16px }
    .modal h2{ margin:0 0 8px 0; font-size:16px }
    .row{ display:flex; align-items:center; gap:8px; margin:8px 0 }
    .row input[type="text"]{ flex:1; padding:10px; background:#0f131b; color:var(--text); border:1px solid var(--line); border-radius:10px }
    .hint{ font-size:12px; color:var(--sub) }
    .pill{ font-size:11px; border:1px solid var(--line); padding:2px 6px; border-radius:999px; color:var(--sub) }
    .sticky-note{font-size:12px; color:var(--sub); margin-top:8px}
  </style>
</head>
<body>
  <header>
    <h1>Tour de rôle</h1>
    <div class="tools">
      <input type="date" id="datePicker"/>
      <button class="btn" id="reloadBtn" title="Recharger">↻</button>
      <button class="btn" id="settingsBtn" title="Paramètres">⚙️</button>
    </div>
  </header>

  <div class="wrap">
    <div id="notice" class="sticky-note"></div>

    <table id="roleTable" class="hidden">
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="footbar">
      <button class="btn approve" id="validateBtn">Valider</button>
    </div>
  </div>

  <!-- Modal paramètres -->
  <div class="modal-backdrop hidden" id="modal">
    <div class="modal">
      <h2>Paramètres</h2>
      <div class="row">
        <label for="apiUrl" class="pill">API GAS</label>
        <input type="text" id="apiUrl" placeholder="https://script.google.com/macros/s/XXXXX/exec">
      </div>
      <div class="hint">
        Colle ici l’URL de ton déploiement WebApp <b>Google Apps Script</b> (réponse JSON).<br>
        L’index récupère dynamiquement <i>toutes</i> les colonnes de la feuille Équipe (sauf <b>ID</b> et <b>NOM</b>) pour créer les cases.
      </div>
      <div class="footbar" style="justify-content:flex-end">
        <button class="btn" id="closeModal">Annuler</button>
        <button class="btn primary" id="saveSettings">Enregistrer</button>
      </div>
    </div>
  </div>

  <script>
    // -------- Config & état
    const DEFAULT_FUNCTIONS = ["CM","LIV","HC","DK","DKT","STR","VL","CPO","CPV","SPE","FOR","DEL","CEQ"];
    const state = {
      apiUrl: localStorage.getItem('API_URL') || "",
      date: null,
      functions: [],
      team: [],          // [{id, nom, skills:{FUNC:true/false}, tours:{FUNC:number}}]
      assignments: {},   // {id: "FUNC"}
      retourAbs: new Set()
    };

    // -------- Helpers
    const $ = (sel) => document.querySelector(sel);
    function isoDate(d){ return d.toISOString().slice(0,10); }
    function todayLocal(){
      const now = new Date();
      const tzOff = now.getTimezoneOffset();
      return new Date(now.getTime() - tzOff*60000); // to local ISO date for input
    }
    function setNotice(msg){ $('#notice').innerHTML = msg || ""; }

    // -------- Chargement
    function init(){
      $('#datePicker').value = isoDate(todayLocal());
      state.date = $('#datePicker').value;
      $('#settingsBtn').addEventListener('click', openSettings);
      $('#closeModal').addEventListener('click', closeSettings);
      $('#saveSettings').addEventListener('click', saveSettings);
      $('#reloadBtn').addEventListener('click', reload);
      $('#validateBtn').addEventListener('click', validate);
      $('#apiUrl').value = state.apiUrl;
      $('#datePicker').addEventListener('change', () => {
        state.date = $('#datePicker').value;
        reload();
      });
      reload();
    }

    async function reload(){
      setNotice('Chargement…');
      try{
        const data = await fetchData(state.apiUrl, state.date);
        applyData(data);
        renderTable();
        setNotice(state.apiUrl ? 'Données chargées depuis l’API GAS.' :
                 'Mode local (démo). Renseigne l’URL GAS (⚙️) pour charger ta feuille.');
      }catch(err){
        console.error(err);
        setNotice('<span class="pill">Erreur</span> Impossible de charger les données.');
      }
    }

    async function fetchData(apiUrl, date){
      if(apiUrl){
        const url = apiUrl + (apiUrl.includes('?') ? '&' : '?') + 'date=' + encodeURIComponent(date);
        const res = await fetch(url, {headers:{'Accept':'application/json'}});
        if(!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      }else{
        // Fallback local — structure attendue par le rendu
        return mockData(date);
      }
    }

    function mockData(date){
      const team = [
        {id:"77836", nom:"SCHITZ GUILLAUME"},
        {id:"77985", nom:"GUIRAMAND JEROME"},
        {id:"78028", nom:"MALATRAIT JULIEN"},
        {id:"78090", nom:"SIMITSIDIS YOHAN"}
      ];
      // Compétences : X = true (pour démo)
      const skills = {
        "77836": {CM:true, LIV:true, HC:true, STR:false, VL:false, CPO:false, SPE:false, FOR:true, DEL:true, CEQ:true, DK:false, DKT:false, CPV:false},
        "77985": {CM:false, LIV:false, HC:true, STR:true, VL:false, CPO:true, SPE:false, FOR:false, DEL:false, CEQ:false, DK:false, DKT:false, CPV:false},
        "78028": {CM:false, LIV:false, HC:true, STR:true, VL:false, CPO:true, SPE:true, FOR:false, DEL:false, CEQ:false, DK:false, DKT:false, CPV:false},
        "78090": {CM:false, LIV:false, HC:true, STR:true, VL:false, CPO:false, SPE:false, FOR:false, DEL:false, CEQ:false, DK:false, DKT:false, CPV:false},
      };
      const tours = {}; // chiffres de tour (optionnel)
      for(const id in skills){
        tours[id] = {};
        DEFAULT_FUNCTIONS.forEach(f => tours[id][f] = Math.floor(Math.random()*12)+1);
      }
      return {date, functions: DEFAULT_FUNCTIONS, team: team.map(p => ({
        id:p.id, nom:p.nom, skills: skills[p.id] || {}, tours: tours[p.id] || {}
      })), assignments: {} };
    }

    function applyData(data){
      state.functions = Array.from(data.functions || []).filter(f => !/^ID$|^NOM$/i.test(f));
      if(state.functions.length === 0) state.functions = DEFAULT_FUNCTIONS;
      state.team = data.team || [];
      state.assignments = data.assignments || {};
      state.retourAbs = new Set();
    }

    // -------- Rendu
    function renderTable(){
      const thead = $('#thead'); const tbody = $('#tbody');
      const table = $('#roleTable'); table.classList.remove('hidden');
      // En-têtes
      thead.innerHTML = "";
      const trh = document.createElement('tr');
      const thName = document.createElement('th'); thName.textContent = "Nom"; trh.appendChild(thName);
      state.functions.forEach(fn => {
        const th = document.createElement('th'); th.textContent = fn; trh.appendChild(th);
      });
      const thAbs = document.createElement('th'); thAbs.textContent = "Retour ABS"; trh.appendChild(thAbs);
      thead.appendChild(trh);

      // Lignes équipe
      tbody.innerHTML = "";
      for(const person of state.team){
        const tr = document.createElement('tr');
        const tdName = document.createElement('td'); tdName.textContent = person.nom || ""; tr.appendChild(tdName);

        state.functions.forEach(fn => {
          const td = document.createElement('td');
          const cell = document.createElement('div'); cell.className = 'cell';
          const skill = !!(person.skills && (person.skills[fn] === true || (typeof person.skills[fn] === 'string' && person.skills[fn].toUpperCase() === 'X')));
          
          const btn = document.createElement('button');
          btn.className = 'assign';
          btn.textContent = fn;
          btn.disabled = !skill;

          const badge = document.createElement('span');
          badge.className = 'badge';
          const tour = person.tours && (person.tours[fn] ?? "");
          badge.textContent = tour !== "" && tour !== undefined ? "#" + tour : "-";

          if(state.assignments[person.id] === fn){
            btn.classList.add('active');
          }

          btn.addEventListener('click', () => {
            if(btn.disabled) return;
            // Règle: 1 fonction par jour et par personne
            if(state.assignments[person.id] === fn){
              delete state.assignments[person.id];
              btn.classList.remove('active');
            }else{
              // désactiver l'ancienne cellule active de la ligne
              const rowBtns = tr.querySelectorAll('.assign.active');
              rowBtns.forEach(b => b.classList.remove('active'));
              state.assignments[person.id] = fn;
              btn.classList.add('active');
              // toute sortie ABS est annulée
              state.retourAbs.delete(person.id);
              const absBtn = tr.querySelector('.assign.abs');
              if(absBtn) absBtn.classList.remove('active');
            }
          });

          cell.appendChild(btn);
          cell.appendChild(badge);
          td.appendChild(cell);
          tr.appendChild(td);
        });

        // Retour ABS
        const tdAbs = document.createElement('td');
        const cellAbs = document.createElement('div'); cellAbs.className = 'cell';
        const btnAbs = document.createElement('button');
        btnAbs.className = 'assign abs';
        btnAbs.textContent = 'RETOUR ABS';
        btnAbs.addEventListener('click', () => {
          // annule l'affectation du jour et passe la personne en "retour abs"
          delete state.assignments[person.id];
          state.retourAbs.add(person.id);
          // visuel
          tr.querySelectorAll('.assign').forEach(b => b.classList.remove('active'));
          btnAbs.classList.add('active');
        });
        cellAbs.appendChild(btnAbs);
        tdAbs.appendChild(cellAbs);
        tr.appendChild(tdAbs);

        tbody.appendChild(tr);
      }
    }

    // -------- Actions
    function openSettings(){ $('#modal').classList.remove('hidden'); }
    function closeSettings(){ $('#modal').classList.add('hidden'); }
    function saveSettings(){
      const val = $('#apiUrl').value.trim();
      state.apiUrl = val;
      localStorage.setItem('API_URL', val);
      closeSettings();
      reload();
    }

    async function validate(){
      const payload = {
        date: state.date,
        assignments: state.assignments,
        retourAbs: Array.from(state.retourAbs)
      };
      if(!state.apiUrl){
        alert('Mode démo : colle ton URL GAS (⚙️) pour envoyer les données.');
        return;
      }
      try{
        const res = await fetch(state.apiUrl, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        alert(data?.message || 'Enregistré !');
      }catch(e){
        console.error(e);
        alert('Erreur lors de l\'enregistrement.');
      }
    }

    // Boot
    init();
  </script>
</body>
</html>
