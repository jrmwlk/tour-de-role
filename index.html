<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tours de rÃ´le â€“ Interface</title>
  <style>
    :root{
      --bg:#0f1115;
      --card:#161a21;
      --text:#e9eef7;
      --muted:#98a2b3;
      --accent:#4CAF50;       /* semaine */
      --accent-2:#FF7043;     /* dimanche/OT */
      --line:#262b36;
      --btn:#232a36;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:12px 0 8px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .pill{padding:6px 10px;border-radius:999px;background:#1e2430;color:var(--muted);font-size:12px;border:1px solid var(--line)}
    .small{font-size:12px;color:var(--muted)}
    input{background:#151a22;border:1px solid var(--line);color:var(--text);padding:10px;border-radius:10px;outline:none}
    button{border:0;padding:8px 10px;border-radius:10px;color:white;font-weight:600;cursor:pointer}
    .btn-semaine{background:var(--accent)}
    .btn-ot{background:var(--accent-2)}
    .btn-ghost{background:#232a36;color:#eaeef7;border:1px solid var(--line)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:960px){.grid{grid-template-columns:1.6fr .9fr}}
    .member-row{display:grid;grid-template-columns:1fr repeat(6, max-content);gap:8px;align-items:center;border-bottom:1px dashed var(--line);padding:8px 0}
    .member-row:last-child{border-bottom:0}
    .fn-label{font-weight:700}
    .foot{opacity:.8;font-size:12px;margin-top:8px}
    .tag{background:#1e2430;border:1px solid var(--line);color:#cbd5e1;padding:4px 8px;border-radius:999px;font-size:12px}
    .list{display:flex;gap:6px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ§­ Tours de rÃ´le</h1>

    <div class="card">
      <div class="row">
        <div class="pill">Date</div>
        <input id="dateInput" type="date"/>
        <div class="pill">Feuille</div>
        <input id="sheetId" placeholder="SHEET_ID (optionnel)"/>
      </div>
      <div class="foot">OT = Overtime (dimanche/samedi soir/jours fÃ©riÃ©s). Utilise les boutons **OT** quand applicable.</div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="pill">Affectations du jour â€” 1 ligne par membre</div>
          <div class="small">1 seule fonction par personne</div>
        </div>
        <div id="members"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="pill">Historique (local)</div>
          <div class="row">
            <button class="btn-ghost" id="exportJson">Exporter JSON</button>
            <button class="btn-ghost" id="clearHistory">Vider</button>
          </div>
        </div>
        <div id="history"></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <div class="pill">Retour congÃ©s / ABS (en bas)</div>
        <button class="btn-ghost" id="reloadTeam">Recharger Ã©quipe (Sheet)</button>
      </div>
      <div class="small">Cliquer place le membre **dernier** dans toutes ses listes de tours.</div>
      <div id="teamList" class="list" style="margin-top:8px"></div>
    </div>

    <div class="foot">v0.4 â€” Interface par membre (CM / CM OT / CPO / CPO OT / STR / STR OT). CM & conduite ont double tour (semaine/OT). HC & SPE restent en tour unique (assignables via bouton HC/SPE ci-dessous si besoin).</div>
  </div>

<script>
/** =========================
 *  CONFIG & DATA
 *  ========================= */
const CONFIG = {
  SHEET_ID: "",
  TEAM_SHEET_NAME: "Equipe",
};

let TEAM = [
  "SCHITZ GUILLAUME",
  "GUIRAMAND JÃ‰RÃ”ME",
  "MALATRAIT JULIEN",
  "SIMITSIDIS YOHAN",
  "DELATTRE ROMAIN",
  "NOVELLI FLORIAN",
  "LOZANO THOMAS",
  "DELATTRE QUENTIN",
  "GATTO BAPTISTE",
  "DEJAMEAU THÃ‰O",
  "LOZANO PAUL",
  "SERRES MAX"
].sort();

const LS_KEYS = {
  ROSTERS: "tdr_rosters_v04",
  HISTORY: "tdr_history_v04",
};

const DEFAULT_ROSTERS = {
  CM:     { semaine: [], dimanche: [] },   // dimanche = OT
  STR:    { semaine: [], dimanche: [] },
  CPO:    { semaine: [], dimanche: [] },
  HC:     { unique: [] },
  SPE:    { unique: [] },
};

function loadLS(key, fallback){
  try{ const raw = localStorage.getItem(key); return raw? JSON.parse(raw): fallback; }
  catch(e){ console.warn(e); return fallback; }
}
function saveLS(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

let ROSTERS = loadLS(LS_KEYS.ROSTERS, DEFAULT_ROSTERS);
let HISTORY = loadLS(LS_KEYS.HISTORY, []);

function ensureTeamInRosters(){
  const ensure = (arr)=>{
    TEAM.forEach(n=>{ if(!arr.includes(n)) arr.push(n); });
    for(let i=arr.length-1;i>=0;i--){ if(!TEAM.includes(arr[i])) arr.splice(i,1); }
  };
  ensure(ROSTERS.CM.semaine); ensure(ROSTERS.CM.dimanche);
  ensure(ROSTERS.STR.semaine); ensure(ROSTERS.STR.dimanche);
  ensure(ROSTERS.CPO.semaine); ensure(ROSTERS.CPO.dimanche);
  ensure(ROSTERS.HC.unique);   ensure(ROSTERS.SPE.unique);
}
ensureTeamInRosters();

/** =========================
 *  UTIL
 *  ========================= */
function getDateStr(){
  const input = document.getElementById("dateInput");
  const d = input.value ? new Date(input.value) : new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function moveToEnd(list, name){
  const idx = list.indexOf(name);
  if(idx>-1){ list.splice(idx,1); list.push(name); }
}
function getPosition(list, name){
  const idx = list.indexOf(name);
  return idx===-1 ? null : (idx+1);
}
function assignedTodaySet(dateStr){
  const set = new Set();
  for(const h of HISTORY){ if(h.date===dateStr){ set.add(h.nom); } }
  return set;
}
function recordHistory(entry){
  HISTORY.push(entry);
  saveLS(LS_KEYS.HISTORY, HISTORY);
  saveToSheets(entry);
}
function saveToSheets(entry){
  console.log("Save to Sheets (stub):", entry);
}

/** =========================
 *  LOGIQUE RETOUR CONGÃ‰S
 *  ========================= */
function retourABS(name){
  moveToEnd(ROSTERS.CM.semaine, name);
  moveToEnd(ROSTERS.CM.dimanche, name);
  moveToEnd(ROSTERS.STR.semaine, name);
  moveToEnd(ROSTERS.STR.dimanche, name);
  moveToEnd(ROSTERS.CPO.semaine, name);
  moveToEnd(ROSTERS.CPO.dimanche, name);
  moveToEnd(ROSTERS.HC.unique, name);
  moveToEnd(ROSTERS.SPE.unique, name);
  saveLS(LS_KEYS.ROSTERS, ROSTERS);
  renderMembers();
}

/** =========================
 *  AFFECTATION PAR MEMBRE
 *  ========================= */
function rotate(list, chosen){
  if(!list.length) return null;
  const name = chosen || list[0];
  const idx = list.indexOf(name);
  if(idx===-1) return null;
  list.splice(idx,1);
  list.push(name);
  return name;
}

function assignForPerson(person, role, isOT=false){
  const dateStr = getDateStr();
  const used = assignedTodaySet(dateStr);
  if(used.has(person)){
    alert(person+" a dÃ©jÃ  une affectation aujourd'hui.");
    return;
  }

  const type = isOT ? "dimanche" : "semaine";

  if(role==="CM"){
    const list = ROSTERS.CM[type];
    if(!list.includes(person)) list.push(person);
    rotate(list, person);
    recordHistory({date:dateStr, nom:person, fonction:"CM", type, position:getPosition(list, person)});
  }
  else if(role==="STR" || role==="CPO"){
    const mainList = ROSTERS[role][type];
    if(!mainList.includes(person)) mainList.push(person);
    rotate(mainList, person);
    // rÃ¨gle conduite: aussi dernier dans l'autre liste du mÃªme type
    const otherKey = role==="STR" ? "CPO" : "STR";
    const otherList = ROSTERS[otherKey][type];
    if(!otherList.includes(person)) otherList.push(person);
    moveToEnd(otherList, person);
    recordHistory({date:dateStr, nom:person, fonction:role, type, position:getPosition(mainList, person)});
  }
  else if(role==="HC" || role==="SPE"){
    const list = ROSTERS[role].unique;
    if(!list.includes(person)) list.push(person);
    rotate(list, person);
    recordHistory({date:dateStr, nom:person, fonction:role, type, position:getPosition(list, person)});
  }

  saveLS(LS_KEYS.ROSTERS, ROSTERS);
  renderMembers();
  renderHistory();
}

/** =========================
 *  UI â€” MEMBRES AVEC BOUTONS
 *  ========================= */
function memberRowHTML(name){
  return `
  <div class="member-row">
    <div class="fn-label">${name}</div>
    <button class="btn-semaine" data-name="${name}" data-role="CM"  data-ot="0">CM</button>
    <button class="btn-ot"      data-name="${name}" data-role="CM"  data-ot="1">CM OT</button>
    <button class="btn-semaine" data-name="${name}" data-role="CPO" data-ot="0">CPO</button>
    <button class="btn-ot"      data-name="${name}" data-role="CPO" data-ot="1">CPO OT</button>
    <button class="btn-semaine" data-name="${name}" data-role="STR" data-ot="0">STR</button>
    <button class="btn-ot"      data-name="${name}" data-role="STR" data-ot="1">STR OT</button>
  </div>`;
}
function renderMembers(){
  ensureTeamInRosters();
  const box = document.getElementById("members");
  box.innerHTML = TEAM.map(memberRowHTML).join("");

  box.querySelectorAll("button").forEach(btn=>{
    const name = btn.getAttribute("data-name");
    const role = btn.getAttribute("data-role");
    const isOT = btn.getAttribute("data-ot")==="1";
    btn.addEventListener("click", ()=> assignForPerson(name, role, isOT));
  });
}

/** =========================
 *  UI â€” HISTORIQUE & TEAM (RETOUR CONGÃ‰S)
 *  ========================= */
function renderHistory(){
  const box = document.getElementById("history");
  if(!HISTORY.length){ box.innerHTML = `<div class="small">Aucun enregistrement pour lâ€™instant.</div>`; return; }
  const rows = [...HISTORY].reverse().slice(0,200).map(h=>{
    return `<div class="row" style="justify-content:space-between;border-bottom:1px dashed var(--line);padding:6px 0">
      <div>${h.date}</div>
      <div>${h.nom}</div>
      <div class="pill">${h.fonction}</div>
      <div class="pill" style="background:${h.type==='semaine'?'#1f3a26':'#3a211b'}">${h.type==='semaine'?'SEMAINE':'OT'}</div>
      <div class="small">pos: ${h.position??'â€”'}</div>
    </div>`
  }).join("");
  box.innerHTML = rows;
}

function renderTeam(){
  const box = document.getElementById("teamList");
  box.innerHTML = "";
  TEAM.forEach(name=>{
    const tag = document.createElement("div");
    tag.className = "tag";
    tag.innerHTML = `
      <span>${name}</span>
      <button class="btn-ghost" style="margin-left:6px" data-name="${name}">RETOUR CONGÃ‰S</button>
    `;
    box.appendChild(tag);
  });
  box.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      const name = e.target.getAttribute("data-name");
      retourABS(name);
    });
  });
}

/** =========================
 *  SHEETS LOADING (OPTIONNEL)
 *  ========================= */
async function loadTeamFromSheet(sheetId){
  try{
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(CONFIG.TEAM_SHEET_NAME)}`;
    const res = await fetch(url);
    const text = await res.text();
    const json = JSON.parse(text.substring(47, text.length - 2));
    const rows = json.table.rows;
    const names = [];
    for(const r of rows){
      const c0 = r.c && r.c[0] ? r.c[0].v : null;
      if(c0 && typeof c0 === "string") names.push(c0.trim());
    }
    if(names.length){
      TEAM = [...new Set(names)].sort();
      ensureTeamInRosters();
      renderMembers();
      renderTeam();
    }else{
      alert("Aucun nom trouvÃ© dans la sheet.");
    }
  }catch(e){
    console.warn(e);
    alert("Ã‰chec du chargement depuis la sheet. VÃ©rifie l'ID et la publication.");
  }
}

/** =========================
 *  EXPORT / CLEAR
 *  ========================= */
document.getElementById("exportJson").addEventListener("click", ()=>{
  const payload = { rosters: ROSTERS, history: HISTORY };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `tours_role_${Date.now()}.json`; a.click();
  URL.revokeObjectURL(url);
});

document.getElementById("clearHistory").addEventListener("click", ()=>{
  if(confirm("Vider lâ€™historique local ?")){
    HISTORY = [];
    saveLS(LS_KEYS.HISTORY, HISTORY);
    renderHistory();
  }
});

/** =========================
 *  INIT
 *  ========================= */
(function init(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  document.getElementById("dateInput").value = `${yyyy}-${mm}-${dd}`;

  const sheetField = document.getElementById("sheetId");
  sheetField.value = CONFIG.SHEET_ID;
  sheetField.addEventListener("change", (e)=>{ CONFIG.SHEET_ID = e.target.value.trim(); });

  document.getElementById("reloadTeam").addEventListener("click", ()=>{
    if(!CONFIG.SHEET_ID){ alert("Renseigne dâ€™abord un SHEET_ID."); return; }
    loadTeamFromSheet(CONFIG.SHEET_ID);
  });

  renderMembers();
  renderHistory();
  renderTeam();
})();
</script>
</body>
</html>
